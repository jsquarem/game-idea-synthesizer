generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships   WorkspaceMembership[]
  aiConfigs     WorkspaceAiConfig[]
  projects      Project[]

  @@index([createdAt])
}

model WorkspaceMembership {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      AppUser   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

model WorkspaceAiConfig {
  id               String   @id @default(cuid())
  workspaceId      String
  providerId       String
  encryptedApiKey  String
  baseUrl          String?
  defaultModel     String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, providerId])
  @@index([workspaceId])
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  genre       String?
  platform    String?
  status      String   @default("ideation")
  workspaceId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace               Workspace?                @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  brainstorms             BrainstormSession[]
  synthesizedOutputs      SynthesizedOutput[]
  gameSystems            GameSystem[]
  versionPlans           VersionPlan[]
  promptHistories        PromptHistory[]
  exports                Export[]
  memberships            ProjectMembership[]
  ideaStreamThreads      IdeaStreamThread[]
  ideaStreamMessages     IdeaStreamMessage[]
  ideaStreamThreadReads  IdeaStreamThreadRead[]
  contextSnapshots        ProjectContextSnapshot[]

  @@index([status])
  @@index([createdAt])
  @@index([workspaceId])
}

model AppUser {
  id          String   @id @default(cuid())
  email       String?  @unique
  displayName String?
  avatarColor String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  memberships           ProjectMembership[]
  workspaceMemberships  WorkspaceMembership[]
  ideaStreamThreads     IdeaStreamThread[]
  ideaStreamMessages    IdeaStreamMessage[]
  ideaStreamThreadReads IdeaStreamThreadRead[]
}

model ProjectMembership {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    AppUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model BrainstormSession {
  id              String   @id @default(cuid())
  projectId       String
  title           String
  source          String   @default("manual")
  content         String
  author          String?
  tags            String?
  sourceThreadIds String?
  createdAt       DateTime @default(now())

  project             Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  synthesizedOutputs  SynthesizedOutput[]

  @@index([projectId])
  @@index([createdAt])
}

model SynthesizedOutput {
  id                   String   @id @default(cuid())
  projectId            String
  brainstormSessionId  String
  title                String
  content              String
  extractedSystems     String
  extractedSystemDetails String?
  status               String   @default("pending")
  aiProvider           String?
  aiModel              String?
  promptTokens         Int?
  completionTokens     Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  project            Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  brainstormSession  BrainstormSession @relation(fields: [brainstormSessionId], references: [id], onDelete: Cascade)
  gameSystems        GameSystem[]
  systemDetails      SystemDetail[]
  conversationMessages SynthesisConversationMessage[]

  @@index([projectId])
  @@index([brainstormSessionId])
  @@index([status])
}

model SynthesisConversationMessage {
  id                   String   @id @default(cuid())
  synthesizedOutputId  String
  role                 String
  content              String
  createdAt            DateTime @default(now())

  synthesizedOutput SynthesizedOutput @relation(fields: [synthesizedOutputId], references: [id], onDelete: Cascade)

  @@index([synthesizedOutputId])
}

model GameSystem {
  id                   String   @id @default(cuid())
  projectId            String
  synthesizedOutputId  String?
  systemSlug           String
  name                 String
  version              String   @default("v0.1")
  status               String   @default("draft")
  purpose              String?
  currentState         String?
  targetState          String?
  coreMechanics        String?
  inputs               String?
  outputs              String?
  failureStates        String?
  scalingBehavior      String?
  mvpCriticality       String   @default("important")
  implementationNotes  String?
  openQuestions        String?
  markdownContent      String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  project           Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  synthesizedOutput SynthesizedOutput? @relation(fields: [synthesizedOutputId], references: [id], onDelete: SetNull)

  dependsOn         Dependency[]       @relation("DependsOn")
  dependedOnBy      Dependency[]       @relation("DependedOnBy")
  changeLogs        ChangeLog[]
  versionPlanItems  VersionPlanItem[]
  promptHistories   PromptHistory[]
  systemDetails     SystemDetail[]

  @@unique([projectId, systemSlug])
  @@index([projectId])
  @@index([status])
  @@index([mvpCriticality])
}

model ProjectContextSnapshot {
  id                       String    @id @default(cuid())
  projectId                String
  content                  String
  contentVersion           Int       @default(1)
  trigger                  String    @default("synthesis")
  relatedSynthesisOutputId  String?
  relatedBrainstormSessionId String?
  createdAt                DateTime  @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, createdAt])
}

model SystemDetail {
  id                   String   @id @default(cuid())
  gameSystemId         String
  name                 String
  detailType           String
  spec                 String
  sortOrder            Int      @default(0)
  synthesizedOutputId  String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  gameSystem  GameSystem         @relation(fields: [gameSystemId], references: [id], onDelete: Cascade)
  synthesizedOutput SynthesizedOutput? @relation(fields: [synthesizedOutputId], references: [id], onDelete: SetNull)

  @@index([gameSystemId])
  @@index([synthesizedOutputId])
}

model Dependency {
  id             String   @id @default(cuid())
  sourceSystemId String
  targetSystemId String
  dependencyType String   @default("requires")
  description    String?
  createdAt      DateTime @default(now())

  sourceSystem GameSystem @relation("DependsOn", fields: [sourceSystemId], references: [id], onDelete: Cascade)
  targetSystem GameSystem @relation("DependedOnBy", fields: [targetSystemId], references: [id], onDelete: Cascade)

  @@unique([sourceSystemId, targetSystemId])
  @@index([sourceSystemId])
  @@index([targetSystemId])
}

model ChangeLog {
  id           String   @id @default(cuid())
  gameSystemId String
  version      String
  summary      String
  details      String?
  changeType   String   @default("update")
  author       String?
  createdAt    DateTime @default(now())

  gameSystem GameSystem @relation(fields: [gameSystemId], references: [id], onDelete: Cascade)

  @@index([gameSystemId])
  @@index([createdAt])
}

model VersionPlan {
  id                 String    @id @default(cuid())
  projectId          String
  versionLabel       String
  title              String
  description        String?
  status             String    @default("draft")
  includedSystems    String
  excludedSystems    String?
  phases             String?
  milestones         String?
  riskAreas          String?
  implementationOrder String?
  scopeValidation    String?
  markdownContent    String?
  finalizedAt        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  project   Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  planItems VersionPlanItem[]

  @@unique([projectId, versionLabel])
  @@index([projectId])
  @@index([status])
}

model VersionPlanItem {
  id            String   @id @default(cuid())
  versionPlanId String
  gameSystemId  String
  phase         Int      @default(1)
  sortOrder     Int      @default(0)
  notes         String?

  versionPlan VersionPlan @relation(fields: [versionPlanId], references: [id], onDelete: Cascade)
  gameSystem  GameSystem  @relation(fields: [gameSystemId], references: [id], onDelete: Cascade)

  @@unique([versionPlanId, gameSystemId])
  @@index([versionPlanId])
}

model PromptHistory {
  id               String   @id @default(cuid())
  projectId        String
  gameSystemId     String?
  versionPlanId    String?
  promptType       String
  promptTemplate   String
  promptInput      String
  promptContext    String?
  response         String?
  aiProvider       String
  aiModel          String
  promptTokens     Int?
  completionTokens Int?
  durationMs       Int?
  status           String   @default("completed")
  error            String?
  createdAt        DateTime @default(now())

  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  gameSystem GameSystem? @relation(fields: [gameSystemId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([gameSystemId])
  @@index([promptType])
  @@index([createdAt])
}

model Export {
  id                   String    @id @default(cuid())
  projectId            String
  exportType           String
  format               String    @default("markdown")
  content              String
  metadata             String?
  synthesizedOutputId  String?
  markedUpToDateAt     DateTime?
  createdAt            DateTime  @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([exportType])
}

model IdeaStreamThread {
  id              String   @id @default(cuid())
  projectId       String
  createdByUserId String
  title           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy AppUser @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  messages IdeaStreamMessage[]
  reads    IdeaStreamThreadRead[]

  @@index([projectId])
  @@index([updatedAt])
}

model IdeaStreamMessage {
  id               String    @id @default(cuid())
  projectId        String
  threadId         String
  parentMessageId  String?
  authorUserId     String
  content          String
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  editedAt         DateTime?
  deletedAt        DateTime?
  deletedByUserId  String?

  project  Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  thread   IdeaStreamThread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  parent   IdeaStreamMessage? @relation("MessageReplies", fields: [parentMessageId], references: [id], onDelete: SetNull)
  replies  IdeaStreamMessage[] @relation("MessageReplies")
  author   AppUser            @relation(fields: [authorUserId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@index([projectId, updatedAt])
  @@index([parentMessageId])
}

model IdeaStreamThreadRead {
  id         String   @id @default(cuid())
  projectId  String
  threadId   String
  userId     String
  lastReadAt DateTime @default(now())

  project Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  thread  IdeaStreamThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user    AppUser          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
  @@index([projectId])
}
